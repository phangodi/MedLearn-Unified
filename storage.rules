rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Post attachments (community posts)
    match /attachments/{fileName} {
      // Anyone can read attachments
      allow read: if true;

      // Only authenticated users can upload attachments
      // Max file size: 150MB (increased for large lecture PDFs/videos)
      allow write: if request.auth != null &&
                     request.resource.size < 150 * 1024 * 1024;

      // Authenticated users can delete their own attachments
      allow delete: if request.auth != null;
    }

    // Flashcard images
    match /flashcards/images/{cardId}/{fileName} {
      // Anyone can read flashcard images
      allow read: if true;

      // Authenticated users can upload flashcard images
      // Max file size: 10MB (images are compressed client-side to ~1MB)
      allow write: if request.auth != null &&
                     request.resource.size < 10 * 1024 * 1024;

      // Authenticated users can delete flashcard images
      allow delete: if request.auth != null;
    }

    // User uploads (posts, attachments)
    match /uploads/{userId}/{fileName} {
      // Anyone can read uploaded files
      allow read: if true;

      // Only authenticated users can upload to their own folder
      // Max file size: 50MB
      allow write: if request.auth != null &&
                     request.auth.uid == userId &&
                     request.resource.size < 50 * 1024 * 1024;
    }

    // User avatars
    match /avatars/{userId} {
      allow read: if true;

      // Users can only upload their own avatar
      // Max size: 5MB
      allow write: if request.auth != null &&
                     request.auth.uid == userId &&
                     request.resource.size < 5 * 1024 * 1024;
    }
  }
}
